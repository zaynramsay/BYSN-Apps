---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ContentBlock from '@/components/ContentBlock.astro';
import { APPS } from '@/lib/constants';
import { policyData } from '@/data/privacy-cake';

const { meta, sections, footer, navGroups } = policyData;

const policySections = sections.map((s) => ({ id: s.id, label: s.label }));
const navGroupsResolved = navGroups.map((g) => ({
  title: g.title,
  items: policySections.slice(g.sectionIndices[0], g.sectionIndices[1]),
}));
---

<BaseLayout
  title={`Privacy Policy - ${APPS.cake.name} – ${APPS.cake.tagline}`}
  description={meta.description}
  variant="privacy"
>
  <main class="legal-shell">
    <div class="legal-grid">
      <aside class="legal-sidebar">
        <div class="sidebar-frame">
          <p class="sidebar-kicker">User Agreements</p>
          {
            navGroupsResolved.map((group) => (
              <div class="nav-group">
                <h2 class="nav-group-title">{group.title}</h2>
                <nav>
                  <ul class="nav-list">
                    {group.items.map((item) => (
                      <li>
                        <a href={`#${item.id}`} class="nav-item" data-section-link={item.id}>
                          <svg viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M7 3.75A2.25 2.25 0 0 0 4.75 6v12A2.25 2.25 0 0 0 7 20.25h10A2.25 2.25 0 0 0 19.25 18V8.31a2.25 2.25 0 0 0-.66-1.59l-2.31-2.31a2.25 2.25 0 0 0-1.59-.66H7Zm0 1.5h7.25v2.5c0 .97.78 1.75 1.75 1.75h1.75V18a.75.75 0 0 1-.75.75H7A.75.75 0 0 1 6.25 18V6A.75.75 0 0 1 7 5.25Zm8.75 1.06 1.44 1.44h-1.19a.25.25 0 0 1-.25-.25V6.31Zm-7 7.19h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1 0-1.5Zm0-3h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5Z" />
                          </svg>
                          <span>{item.label}</span>
                        </a>
                      </li>
                    ))}
                  </ul>
                </nav>
              </div>
            ))
          }
        </div>
      </aside>

      <section class="legal-main">
        <p class="legal-breadcrumb">
          <span>Legal Notes</span>
          <span class="breadcrumb-separator">›</span>
          <strong>Privacy Policy</strong>
        </p>

        <h1 class="legal-title">Privacy Policy</h1>
        <p class="legal-meta">Effective: {meta.effective} | Last Updated: {meta.lastUpdated}</p>

        <article class="content">
          {sections.map((section) => (
            <>
              <h2 id={section.id}>{section.title}</h2>

              {section.content && section.subsections
                ? section.content.filter((b) => b.type !== 'divider').map((block) => (
                    <ContentBlock block={block} />
                  ))
                : null}

              {section.subsections?.map((sub) => (
                <>
                  <h3>{sub.title}</h3>
                  {sub.content.map((block) => (
                    <ContentBlock block={block} />
                  ))}
                </>
              ))}

              {section.content && !section.subsections
                ? section.content.map((block) => (
                    <ContentBlock block={block} />
                  ))
                : null}

              {section.content && section.subsections
                ? section.content.filter((b) => b.type === 'divider').map(() => <div class="section-divider" />)
                : null}
            </>
          ))}

          <div class="footer-note">
            <p>
              <strong>Effective Date:</strong> {footer.effective} | <strong>Last Updated:</strong> {footer.lastUpdated}<br />
              <strong set:html={footer.acceptance} /><br />
              <br />
              {footer.closing}
            </p>
          </div>
        </article>
      </section>
    </div>
  </main>
</BaseLayout>

<script>
  const links = Array.from(document.querySelectorAll('.nav-item[data-section-link]'));
  const trackedSections = links
    .map((link) => {
      const id = link.getAttribute('data-section-link');
      const section = id ? document.getElementById(id) : null;
      if (!id || !section) return null;
      return { id, section };
    })
    .filter(Boolean);

  const setActive = (id: string) => {
    links.forEach((link) => {
      link.classList.toggle('active', link.getAttribute('data-section-link') === id);
    });
  };

  const observer = new IntersectionObserver(
    (entries) => {
      const visibleSections = entries
        .filter((entry) => entry.isIntersecting)
        .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

      if (visibleSections.length > 0) {
        setActive(visibleSections[0].target.id);
      }
    },
    {
      rootMargin: '-24% 0px -65% 0px',
      threshold: [0, 0.1, 0.35],
    }
  );

  trackedSections.forEach(({ section }) => observer.observe(section));

  links.forEach((link) => {
    link.addEventListener('click', () => {
      const id = link.getAttribute('data-section-link');
      if (id) setActive(id);
    });
  });

  if (trackedSections[0]) setActive(trackedSections[0].id);
</script>

<style>
  .legal-shell {
    min-height: 100vh;
    padding: clamp(1.25rem, 2vw, 2.5rem);
    color: #ecedf3;
  }

  .legal-grid {
    max-width: 1480px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: minmax(260px, 330px) minmax(0, 1fr);
    gap: clamp(1.5rem, 3vw, 3.5rem);
    align-items: start;
  }

  .legal-sidebar {
    position: sticky;
    top: 1.25rem;
  }

  .sidebar-frame {
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background:
      radial-gradient(circle at 0% 0%, rgba(252, 61, 79, 0.14) 0%, rgba(252, 61, 79, 0) 38%),
      rgba(13, 15, 22, 0.9);
    backdrop-filter: blur(16px);
    padding: clamp(1.2rem, 2vw, 1.8rem);
    box-shadow: 0 30px 70px rgba(4, 6, 14, 0.42);
  }

  .sidebar-kicker {
    margin: 0 0 1.25rem;
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: #ff9ca7;
  }

  .nav-group + .nav-group {
    margin-top: 1.4rem;
    padding-top: 1.25rem;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
  }

  .nav-group-title {
    margin: 0 0 0.7rem;
    font-size: 0.95rem;
    font-weight: 700;
    color: #f6f6f9;
  }

  .nav-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 0.3rem;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 0.55rem;
    width: 100%;
    padding: 0.45rem 0.55rem;
    border-radius: 10px;
    color: #a9afbd;
    font-size: 0.93rem;
    font-weight: 560;
    text-decoration: none;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .nav-item svg {
    width: 18px;
    height: 18px;
    fill: currentColor;
    flex: 0 0 auto;
    opacity: 0.8;
  }

  .nav-item:hover {
    color: #f6f7fd;
    background: rgba(255, 255, 255, 0.06);
  }

  .nav-item.active {
    color: #ffffff;
    background: rgba(255, 255, 255, 0.12);
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
  }

  .legal-main {
    border-radius: 30px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background:
      radial-gradient(circle at 80% -10%, rgba(252, 61, 79, 0.15) 0%, rgba(252, 61, 79, 0) 46%),
      rgba(9, 11, 17, 0.84);
    padding: clamp(1.4rem, 3vw, 3.2rem);
    box-shadow: 0 35px 80px rgba(2, 4, 12, 0.52);
  }

  .legal-breadcrumb {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.65rem;
    color: #a0a7b9;
    font-size: 0.96rem;
    font-weight: 500;
  }

  .breadcrumb-separator {
    color: #7f8696;
  }

  .legal-title {
    margin: 1rem 0 0.85rem;
    font-size: clamp(2.3rem, 6vw, 4.2rem);
    letter-spacing: -0.035em;
    line-height: 0.98;
    color: #f9faff;
    text-wrap: balance;
  }

  .legal-meta {
    margin: 0 0 2.2rem;
    color: #b2b8c6;
    font-size: 0.98rem;
  }

  .content h2 {
    margin: 2.8rem 0 1.2rem;
    padding-bottom: 0.65rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-size: clamp(1.55rem, 3.3vw, 2.45rem);
    line-height: 1.13;
    color: #ffffff;
    letter-spacing: -0.024em;
    scroll-margin-top: 5.25rem;
  }

  .content h2:first-child {
    margin-top: 0;
  }

  .content h3 {
    margin: 1.8rem 0 0.95rem;
    font-size: clamp(1.12rem, 2.2vw, 1.45rem);
    color: #f2f5ff;
    line-height: 1.3;
  }

  .content p {
    margin: 0 0 1.1rem;
    color: #c6ccdb;
    line-height: 1.75;
    font-size: 1rem;
  }

  .content ul {
    margin: 0.6rem 0 1.35rem;
    padding: 0;
    list-style: none;
  }

  .content ol {
    margin: 0.6rem 0 1.35rem;
    padding-left: 1.4rem;
  }

  .content li {
    position: relative;
    padding-left: 1.35rem;
    margin-bottom: 0.62rem;
    color: #c6ccdb;
    line-height: 1.65;
  }

  .content ul > li::before {
    content: '';
    position: absolute;
    top: 0.72rem;
    left: 0;
    width: 0.45rem;
    height: 0.45rem;
    border-radius: 50%;
    background: #fc3d4f;
    box-shadow: 0 0 0 3px rgba(252, 61, 79, 0.2);
  }

  .content strong {
    color: #ffd8dd;
  }

  .content code {
    display: inline-block;
    margin: 0 0.1rem;
    padding: 0.1rem 0.42rem;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.08);
    color: #f8f8fc;
    font-size: 0.87rem;
  }

  .content a {
    color: #ff9ca7;
    text-decoration-color: rgba(255, 156, 167, 0.6);
  }

  .summary-box {
    border-radius: 18px;
    border: 1px solid rgba(252, 61, 79, 0.28);
    background: linear-gradient(140deg, rgba(252, 61, 79, 0.16) 0%, rgba(252, 61, 79, 0.06) 100%);
    padding: clamp(1rem, 2vw, 1.7rem);
    margin: 1.8rem 0;
  }

  .summary-box h3 {
    margin-top: 0;
  }

  .table-scroll {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 1.3rem 0;
  }

  .permissions-table,
  .summary-table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.02);
  }

  .permissions-table th,
  .summary-table th {
    background: rgba(255, 255, 255, 0.07);
    color: #f4f5fc;
    text-align: left;
    padding: 0.78rem 0.85rem;
    font-size: 0.84rem;
    letter-spacing: 0.02em;
    white-space: nowrap;
  }

  .permissions-table td,
  .summary-table td {
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    padding: 0.8rem 0.85rem;
    color: #ccd1df;
    font-size: 0.89rem;
    vertical-align: top;
  }

  .permissions-table tr:hover,
  .summary-table tr:hover {
    background: rgba(255, 255, 255, 0.04);
  }

  .section-divider {
    margin: 2.8rem 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.18), transparent);
  }

  .footer-note p {
    text-align: center;
    margin: 0;
    padding: 1.6rem;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(255, 255, 255, 0.03);
    color: #afb5c6;
    font-style: italic;
  }

  @media (max-width: 1180px) {
    .legal-grid {
      grid-template-columns: 1fr;
    }

    .legal-sidebar {
      position: static;
    }

    .sidebar-frame {
      padding: 1rem;
    }

    .nav-list {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (max-width: 820px) {
    .legal-shell {
      padding: 1rem 0.85rem 2rem;
    }

    .legal-main {
      border-radius: 22px;
      padding: 1rem;
    }

    .nav-list {
      grid-template-columns: 1fr;
    }
  }
</style>
